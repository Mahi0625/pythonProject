import pandas as pd
from notifier import send_notification

# def send_price_change_notifications(new_df, existing_df):
#     # Merge the new DataFrame with the existing one to compare prices
#     merged_df = existing_df.merge(new_df, on='product_name', suffixes=('_existing', '_new'))

#     # Filter rows where the discounted price has changed
#     price_changed_df = merged_df[merged_df['discounted_price_existing'] != merged_df['discounted_price_new']]

#     if not price_changed_df.empty:
#         # Create a notification message for price changes
#         price_changed_df['price_change'] = (price_changed_df['discounted_price_existing'] +
#                                             " -> " +
#                                             price_changed_df['discounted_price_new'])

#         notification_text = f"Price changes detected:\n{price_changed_df[['product_name', 'price_change']].to_string(index=False)}"

#         # Send the notification
#         send_notification("Price Changes Alert", notification_text, 'kdhini2807@gmail.com')

#     return new_df




def send_price_change_notifications(existing_data, current_data):
    # Merge the existing data with the current data based on product_name
    merged_data = pd.merge(existing_data, current_data, on='product_name', how='inner', suffixes=('_prev', '_new'))

    # Filter rows where discounted_price_prev is different from discounted_price_new
    price_changed_data = merged_data[merged_data['discounted_price_prev'] != merged_data['discounted_price_new']]

    if not price_changed_data.empty:
        # Create a notification message for price changes
        price_change_notification_text = f"Price changes detected:\n{price_changed_data[['product_name', 'discounted_price_prev', 'discounted_price_new']].to_string(index=False)}"

        # Send the price change notification
        send_notification("Price Changes Alert", price_change_notification_text, 'kdhini2807@gmail.com')

if __name__ == "__main__":
    # Testing the price change notifier
    existing_data = pd.DataFrame({
        'product_name': ['Product1', 'Product2', 'Product3'],
        'discounted_price_prev': [10.0, 20.0, 30.0],
    })

    current_data = pd.DataFrame({
        'product_name': ['Product1', 'Product2', 'Product3'],
        'discounted_price_new': [10.0, 25.0, 30.0],
    })

    send_price_change_notifications(existing_data, current_data)

